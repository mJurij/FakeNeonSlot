<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <title>üé∞ Neon Slot</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); 
            color: #fff; 
            text-align: center; 
            margin: 0; 
            padding: 50px 20px; 
        }

        h1 { 
            font-size: 3em; 
            margin-bottom: 20px; 
            text-shadow: 0 0 10px #00d2ff; 
        }

        .grid { 
            display: flex; 
            justify-content: center; 
            gap: 12px; 
            margin: 20px auto; 
        }

        .column {
            width: 86px;
            height: 248px; 
            overflow: hidden; 
            border-radius: 15px;
            padding: 4px;
            box-sizing: border-box;
            background: #111;
            border: 1px solid #333;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .reel { 
            display: flex; 
            flex-direction: column;
            will-change: transform;
        }

        .cell {
            width: 76px;
            height: 80px;
            flex-shrink: 0;
            border-radius: 12px;
            border: 2px solid #fff;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #222;
            position: relative;
            box-shadow: 0 0 5px #fff inset;
            margin: 0 auto;
            box-sizing: border-box;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .cell img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            pointer-events: none;
        }

        .cell.x { 
            background: gold; 
            color: #000; 
            box-shadow: 0 0 15px gold inset, 0 0 20px gold; 
            z-index: 2; 
            font-size: 24px;
        }

        .cell.win { 
            background: #39ff14; 
            color: #000; 
            box-shadow: 0 0 15px #39ff14 inset, 0 0 30px #39ff14; 
            z-index: 10;
            animation: winPulse 0.5s ease infinite alternate;
        }

        @keyframes winPulse {
            from { transform: scale(1); }
            to { transform: scale(1.15); }
        }

        .subwin {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 11px;
            color: #000;
            font-weight: 800;
            background: rgba(255,255,255,0.8);
            padding: 1px 3px;
            border-radius: 4px;
            pointer-events: none;
        }

        button, select { 
            font-size: 16px; 
            padding: 10px 20px; 
            margin: 8px; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer; 
            background: #ff6f61; 
            color: #fff; 
            font-weight: bold; 
            transition: all 0.2s; 
            box-shadow: 0 4px 0 #d64535; 
        }

        button:hover, select:hover { 
            transform: translateY(-2px); 
            background: #ff856f; 
            box-shadow: 0 6px 0 #d64535; 
        }

        #info { 
            margin-top: 15px; 
            font-size: 20px; 
            font-weight: bold; 
            color: #ffe600; 
            min-height: 1.2em; 
            text-shadow: 0 0 5px #ff0; 
        }

        #winOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        #winMult {
            font-size: 100px;
            color: #39ff14;
            font-weight: 900;
            text-shadow: 0 0 30px #39ff14;
            margin-bottom: 10px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 120px;
            display: flex;
            align-items: center;
        }

        #winLabel { 
            font-size: 24px; 
            color: #ffd700; 
            text-transform: uppercase; 
            letter-spacing: 8px; 
            font-weight: bold;
            margin-bottom: 10px;
        }

        #winAmount {
            font-size: 80px;
            color: #fff;
            font-weight: 900;
            text-shadow: 0 0 20px gold, 0 0 40px red;
        }

        .spin-button {
            position: relative;
            width: 130px;
            height: 130px;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff3366, #ff00aa, #cc00ff);
            box-shadow: 0 0 25px #ff00aa, 0 0 50px #cc00ff, inset 0 0 15px rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.25s ease;
            overflow: hidden;
            margin: 30px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .inner-square {
            width: 65px;
            height: 65px;
            background: rgba(0,0,0,0.7);
            border: 3px solid #00ffff;
            border-radius: 12px;
            box-shadow: inset 0 0 15px #00ffff;
            color: #00ffff;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 8px #00ffff;
        }

        /* STIL ZA STOP GUMB (Auto Mode) */
        .stop-container {
            width: 65px;
            height: 65px;
            background-color: white; /* Rdeƒç kvadrat */
            border: 2px solid #8b0000;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(255,0,0,0.5);
        }

        .stop-circle {
            width: 38px;
            height: 38px;
            background-color: white; /* Bel krog */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ff0000; /* Rdeƒça ≈°tevilka */
            font-size: 18px;
            font-weight: bold;
        }

    </style>
</head>
<body>
    <audio id="bgMusic" src="cyber-music.mp3" loop></audio>
    <audio id="soundSpin" src="https://assets.mixkit.co/active_storage/sfx/1614/1614-preview.mp3"></audio>
    <audio id="soundSmallWin" src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3"></audio>
    <audio id="soundBigWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="soundMult" src="https://assets.mixkit.co/active_storage/sfx/1614/1614-preview.mp3"></audio>

    <div id="winOverlay" onclick="closeOverlay()">
        <div id="winMult"></div>
        <div id="winLabel">BIG WIN!</div>
        <div id="winAmount">‚Ç¨0.00</div>
        <div style="margin-top:40px; font-size:14px; color:#666;">KLIKNI ZA NADALJEVANJE</div>
    </div>

    <h1>üé∞ Neon Slot</h1>
    <p><strong>Balance:</strong> ‚Ç¨<span id="balance">1000.00</span></p>
    
    <label><strong>Bet:</strong> 
        <select id="bet"></select>
    </label>
    <br>
    
    <label><strong>Auto spins:</strong> 
        <select id="autoSpinsSelect">
            <option value="0">OFF</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </label>
    <br>
    
    <button onclick="resetBalance()">RESET BALANCE</button>
    <br>

    <div class="grid" id="grid"></div>
    <p id="info"></p>

    <div style="margin: 30px auto; text-align: center;">
        <button id="spinBtn" class="spin-button" onclick="handleSpinClick()">
            <div id="btnContent" class="inner-square">SPIN</div>
        </button>
    </div>

    <script>
        const bgMusic = document.getElementById("bgMusic");
        let musicStarted = false;

        let autoSpinsLeft = 0;
        let autoMode = false;
        const autoSpinsSelect = document.getElementById('autoSpinsSelect');
        const spinBtn = document.getElementById('spinBtn');
        const btnContent = document.getElementById('btnContent');

        const symbols = [
            { name: 'cherry', src: 'https://i.postimg.cc/Ssp6hQgX/neon-cherry.png' },
            { name: 'lemon',  src: 'https://i.postimg.cc/kg6KRRZ6/neon-lemon.jpg'  },
            { name: 'bar',    src: 'https://i.postimg.cc/mgH1gfzT/neon-watermelon.jpg'},
            { name: 'seven',  src: 'https://i.postimg.cc/nz734wPZ/neon-grapes.png'  }
        ];

        const balanceKey = 'slotBalance';
        let balance = parseFloat(localStorage.getItem(balanceKey)) || 1000;
        document.getElementById('balance').innerText = balance.toFixed(2);

        function playSound(id) {
            const s = document.getElementById(id);
            if (s) { s.currentTime = 0; s.play().catch(e => {}); }
        }

        const betSelect = document.getElementById('bet');
        for (let b = 0.1; b <= 1; b += 0.1) {
            let opt = document.createElement('option');
            let val = Math.round(b * 100) / 100;
            opt.value = val.toFixed(2);
            opt.textContent = "‚Ç¨" + val.toFixed(2);
            betSelect.appendChild(opt);
        }

        function createGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for (let c = 0; c < 5; c++) {
                const col = document.createElement('div');
                col.className = 'column';
                const reel = document.createElement('div');
                reel.className = 'reel';
                for (let r = 0; r < 3; r++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const sym = symbols[Math.floor(Math.random() * symbols.length)];
                    const img = document.createElement('img');
                    img.src = sym.src;
                    img.alt = sym.name;
                    cell.appendChild(img);
                    reel.appendChild(cell);
                }
                col.appendChild(reel);
                grid.appendChild(col);
            }
        }
        createGrid();

        let isSpinning = false;
        let lastSpinWasWin = false;

        // FUNKCIJA ZA POSODABLJANJE IZGLEDA GUMBA
        function updateButtonUI() {
            if (autoMode) {
                btnContent.className = "stop-container";
                btnContent.innerHTML = `<div class="stop-circle">${autoSpinsLeft}</div>`;
            } else {
                btnContent.className = "inner-square";
                btnContent.innerHTML = "SPIN";
            }
        }

        function spin() {
            if (!musicStarted) {
                bgMusic.volume = 0.25;
                bgMusic.play().catch(e => {});
                musicStarted = true;
            }
            if (isSpinning) return;

            const bet = parseFloat(betSelect.value);
            if (bet > balance) { 
                alert("Ni dovolj denarja"); 
                autoMode = false;
                updateButtonUI();
                return; 
            }

            isSpinning = true;
            balance -= bet;
            document.getElementById('balance').innerText = balance.toFixed(2);
            document.getElementById('info').innerText = 'Spinning...';
            
            playSound('soundSpin');

            const columns = document.querySelectorAll('.column');
            let finalGrid = Array.from({ length: 3 }, () => Array(5).fill(null));

            columns.forEach((col, c) => {
                let startSymbols = [];
                const currentCells = col.querySelectorAll('.cell');
                
                if (currentCells.length === 3) {
                    currentCells.forEach(cell => {
                        if (cell.classList.contains('x')) {
                            startSymbols.push(cell.innerText);
                        } else {
                            const img = cell.querySelector('img');
                            if (img) startSymbols.push(img.alt);
                            else startSymbols.push(symbols[0].name);
                        }
                    });
                } else {
                    for(let k=0; k<3; k++) startSymbols.push(symbols[Math.floor(Math.random()*symbols.length)].name);
                }

                const reel = document.createElement('div');
                reel.className = 'reel';
                col.innerHTML = '';
                col.appendChild(reel);

                let visibleSymbols = [];
                for (let r = 0; r < 3; r++) {
                    let isX = Math.random() < 0.02;
                    let val = isX ? getXVal() : symbols[Math.floor(Math.random() * symbols.length)].name;
                    visibleSymbols.push(val);
                    finalGrid[r][c] = val;
                }

                let fakeSymbols = [];
                for (let i = 0; i < 30; i++) {
                    fakeSymbols.push(symbols[Math.floor(Math.random() * symbols.length)].name);
                }

                const allSymbols = [...visibleSymbols, ...fakeSymbols, ...startSymbols];

                allSymbols.forEach(sym => {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (sym.includes('X')) {
                        cell.innerText = sym;
                        cell.classList.add('x');
                    } else {
                        const img = document.createElement('img');
                        const symObj = symbols.find(s => s.name === sym);
                        if (symObj) { img.src = symObj.src; img.alt = symObj.name; }
                        cell.appendChild(img);
                    }
                    reel.appendChild(cell);
                });

                const cellHeight = 80;
                const totalHeight = (allSymbols.length - 3) * cellHeight;
                reel.style.transform = `translateY(-${totalHeight}px)`;
                reel.offsetHeight; 

                const delay = c * 200;
                reel.style.transition = `transform 2s cubic-bezier(.15,.9,.25,1) ${delay}ms`;
                reel.style.transform = `translateY(0)`;
            });

            setTimeout(() => {
                showFinalCells();
                calculateWin(finalGrid, bet);
            }, 3000);
        }

        function getXVal() {
            const roll = Math.random();
            if (roll < 0.4) return '2X';
            if (roll < 0.65) return '3X';
            if (roll < 0.85) return '5X';
            if (roll < 0.97) return '10X';
            return '100X';
        }

        function showFinalCells() {
            const columns = document.querySelectorAll('.column');
            columns.forEach(col => {
                const reel = col.querySelector('.reel');
                const finalThree = Array.from(reel.children).slice(0, 3);
                reel.innerHTML = '';
                finalThree.forEach(c => reel.appendChild(c));
                reel.style.transition = 'none';
                reel.style.transform = 'translateY(0)';
            });
        }

        function calculateWin(grid, bet) {
            let multiplier = 0;
            let cellWins = {};
            let clusters = [];

            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 5; c++) {
                    if (grid[r][c].includes('X')) multiplier += parseInt(grid[r][c].replace('X', ''));
                }
            }

            let displayMultiplier = multiplier;
            if (multiplier === 0) multiplier = 1;

            let visited = Array.from({ length: 3 }, () => Array(5).fill(false));

            function dfs(r, c, symbol, cluster) {
                if (r < 0 || r >= 3 || c < 0 || c >= 5 || visited[r][c] || grid[r][c] !== symbol) return;
                visited[r][c] = true;
                cluster.push([r, c]);
                dfs(r + 1, c, symbol, cluster); dfs(r - 1, c, symbol, cluster);
                dfs(r, c + 1, symbol, cluster); dfs(r, c - 1, symbol, cluster);
            }

            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 5; c++) {
                    if (!visited[r][c] && !grid[r][c].includes('X')) {
                        let cluster = [];
                        dfs(r, c, grid[r][c], cluster);
                        if (cluster.length >= 4) {
                            clusters.push({ cells: cluster });
                            cluster.forEach(([rr, cc]) => {
                                const base = grid[rr][cc] === 'seven' ? bet * 1.0 : grid[rr][cc] === 'bar' ? bet * 0.6 : grid[rr][cc] === 'cherry' ? bet * 0.4 : bet * 0.2;
                                cellWins[rr + '-' + cc] = base;
                            });
                        }
                    }
                }
            }

            const columns = document.querySelectorAll('.column');
            clusters.forEach(cl => {
                cl.cells.forEach(([r, c]) => {
                    const targetCell = columns[c].querySelector('.reel').children[r];
                    if (targetCell) {
                        targetCell.classList.add('win');
                        const span = document.createElement('span');
                        span.className = 'subwin';
                        span.innerText = '‚Ç¨' + cellWins[r + '-' + c].toFixed(2);
                        targetCell.appendChild(span);
                    }
                });
            });

            let totalWin = Object.values(cellWins).reduce((a, b) => a + b, 0) * multiplier;

            if (totalWin > 0) {
                balance += totalWin;
                localStorage.setItem(balanceKey, balance);
                document.getElementById('balance').innerText = balance.toFixed(2);
                document.getElementById('info').innerText = `WIN: ‚Ç¨${totalWin.toFixed(2)}`;
                lastSpinWasWin = true;
                if (totalWin >= bet * 10) {
                    setTimeout(() => { triggerBigWin(totalWin/multiplier, displayMultiplier, totalWin); }, 800);
                } else {
                    playSound('soundSmallWin');
                    finishTurn();
                }
            } else {
                document.getElementById('info').innerText = "Veƒç sreƒçe prihodnjiƒç!";
                lastSpinWasWin = false;
                finishTurn();
            }
        }

        function finishTurn() {
            isSpinning = false;
            if (autoMode && autoSpinsLeft > 0) {
                autoSpinsLeft--;
                updateButtonUI();
                if (autoSpinsLeft <= 0) {
                    autoMode = false;
                    autoSpinsSelect.disabled = false;
                    autoSpinsSelect.value = "0";
                    updateButtonUI();
                } else {
                    nextAutoSpin();
                }
            } else {
                autoMode = false;
                updateButtonUI();
            }
        }

        function triggerBigWin(baseWin, multiplier, totalWin) {
            playSound('soundBigWin');
            const overlay = document.getElementById('winOverlay');
            const amountEl = document.getElementById('winAmount');
            const multEl = document.getElementById('winMult');
            overlay.style.display = 'flex';
            amountEl.innerText = "‚Ç¨" + baseWin.toFixed(2);
            multEl.style.opacity = '0';
            if (multiplier > 1) {
                setTimeout(() => {
                    playSound('soundMult');
                    multEl.innerText = multiplier + "X!";
                    multEl.style.opacity = '1'; multEl.style.transform = 'scale(1.2)';
                    setTimeout(() => { animateValue(amountEl, baseWin, totalWin, 1000); }, 600);
                }, 800);
            } else {
                amountEl.innerText = "‚Ç¨" + totalWin.toFixed(2);
            }
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = "‚Ç¨" + (start + progress * (end - start)).toFixed(2);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function closeOverlay() {
            document.getElementById('winOverlay').style.display = 'none';
            finishTurn();
        }

        function resetBalance() {
            if (isSpinning) return;
            balance = 1000;
            localStorage.setItem(balanceKey, balance);
            document.getElementById('balance').innerText = balance.toFixed(2);
            autoMode = false;
            autoSpinsLeft = 0;
            autoSpinsSelect.disabled = false;
            autoSpinsSelect.value = "0";
            updateButtonUI();
            createGrid();
        }

        function nextAutoSpin() {
            if (!autoMode || autoSpinsLeft <= 0 || isSpinning) return;
            const delay = lastSpinWasWin ? 1500 : 500;
            setTimeout(() => { spin(); }, delay);
        }

        function handleSpinClick() {
            if (autoMode) {
                autoMode = false;
                autoSpinsLeft = 0;
                autoSpinsSelect.disabled = false;
                autoSpinsSelect.value = "0";
                updateButtonUI();
                document.getElementById('info').innerText = 'AUTO ustavljen';
            } else {
                spin();
            }
        }

        autoSpinsSelect.addEventListener('change', function() {
            const selected = parseInt(this.value);
            if (selected > 0) {
                autoSpinsLeft = selected;
                autoMode = true;
                autoSpinsSelect.disabled = true;
                updateButtonUI();
                spin();
            }
        });
    </script>
</body>
</html>